{% extends 'go2base.html' %}
{% import 'plan_icon.html' as plan_icon %}

{% block title %}{% trans %}Grid o'Gigs{% endtrans %}{% endblock title %}

{% block headcontent %}

{# https://greensock.com/forums/topic/17640-horizontal-scroll-with-scrollmagic-gsap/ #}

<style>

main {
    flex-grow: 1; /* Tell the this element to take up as much space is available */
    background: green;
    overflow-x: scroll;
    overflow-y: hidden;
    height: 100%;
    white-space:nowrap;
}

section {
    background: hsl(0, 0%, 80%);
    display: inline-block;
    padding: 4px;
{#
    height: 100%;
#}
    width: 100px;
    box-sizing: border-box;
    
}

article {
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    display: flex;
}
article > * {
    margin: auto;
    padding: 36px;
}


#section-1 {
    background: hsl(0, 100%, 50%)
}

#section-2 {
    background: hsl(90, 100%, 50%)
}

#section-3 {
    background: hsl(180, 100%, 50%)
}

#section-4 {
    background: hsl(270, 100%, 50%)
}
</style>

{% endblock headcontent %}


{% block content %}
<div class="row">
    <div class="mx-auto col-md-10 col-12">
        <div class="page-header">
            {% trans %}Grid o'Gigs{% endtrans %} <b>BETA</b>
            {% if the_user.preferences.default_view != 2 %}
            <small>(<a href="/?default=2">{% trans %}Make this my default view!{% endtrans %}</a>)</small>
            {% endif %}
        </div>
        <div>&nbsp;</div>
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 col-sm-10 col-sm-offset-0">
                {% if all_band_keys|length > 1 %}
                    <div class="dropdown">
                        <a class="btn btn-sm btn-outline-secondary dropdown-toggle text-center" href="#" role="button" data-toggle="dropdown" id="dropdownMenu1">
                            {{ the_band_key.get().name }} <span class="caret"></span>
                        </a>
                        <div class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                            {% for a_band_key in all_band_keys %}
                                <a class="dropdown-item" href="/grid.html?bk={{a_band_key.urlsafe()}}&m={{the_month}}&y={{the_year}}">{{a_band_key.get().name}}</a>
                            {% endfor %}
                        </div>
                    </div> <!-- dropdown -->
                {% endif %}
                <br>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <main id="slideworld"><section id="rightloader" style="width:50px;">
                        <article>
                        	&nbsp;
                        	<div style="padding-right:0px; padding-left:0px;">
                            <i class="fas fa-spinner fa-pulse fa-lg"></i>
                        	</div>
                        </article>
                    </section></main>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block localscripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.js"></script>
{% if the_user.preferences.locale=='en_GB' %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.en-GB.min.js"></script>
{% elif the_user.preferences.locale!='en' %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.{{ the_user.preferences.locale }}.min.js"></script>
{% endif %}


{% if the_user.preferences.locale == 'en' %}
    <script src='/js/moment.min.js'></script>
{% else %}
    <script src='/js/moment-with-locales.min.js'></script>
{% endif %}



<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.2/TweenMax.min.js"></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.6/ScrollMagic.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.6/plugins/animation.gsap.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.6/plugins/debug.addIndicators.js'></script>

<script>

jQuery.expr.filters.offscreen = function(el) {
  var rect = el.getBoundingClientRect();
  console.log(rect)
  return (
           (rect.x + rect.width) < 0 
             || (rect.y + rect.height) < 0
             || (rect.x > window.innerWidth || rect.y > window.innerHeight)
         );
};


var controller = new ScrollMagic.Controller({container: "#slideworld", vertical: false});
var rightfetching = false;
var leftfetching = false;
var leftsetup = false;
var rightscene = new ScrollMagic.Scene({triggerElement: "#rightloader", triggerHook: 1})
    .on("enter", function(e) {
    	if (!rightfetching) {
    		rightfetching = true;
	    	setTimeout(function() {fetchInfo('right')}, 1000);
	        console.log("asking right");
    	}
    })
    .addIndicators()
    .addTo(controller);

var leftscene = null;
function setUpLeft() {
	if (rightfetching) {
		setTimeout(function() {setUpLeft();}, 500);
	} else {
		$("#slideworld").prepend(
			`<section id="leftloader" style="width:50px">
                <article>
                	&nbsp;
                	<div style="padding-right:0px; padding-left:0px;">
                    <i class="fas fa-spinner fa-pulse fa-lg"></i>
                	</div>
                </article>
	        </section>`
	    );
	    controller.scrollTo($('#leftloader').width()+10)
		leftscene = new ScrollMagic.Scene({triggerElement: "#leftloader", triggerHook: 0.01, offset: $("#leftloader").width()})
		    .on("start", function(e) {
		    	if (!leftfetching) {
		    		leftfetching = true;
			    	setTimeout(function() {fetchInfo('left');}, 500);
			        console.log("asking left");
		    	}
		    })
		    .addIndicators()
		    .addTo(controller);
	}
}

function fetchInfo(side) {
    console.log("telling " + side);
	if (side == 'right') {
{#
	    data = `<section id="section-1">
                        <article>
                            One
                        </article>
                    </section><section id="section-2">
                        <article>
                            Two
                        </article>
                    </section>`;
#}

		data = `<section id="section-1">
                        <article>
                            <table>
                            	<tr><td>foo</td></tr><tr><td>foo</td></tr><tr><td>foo</td></tr>
                            	<tr><td>foo</td></tr><tr><td>foo</td></tr><tr><td>foo</td></tr>
                            	<tr><td>foo</td></tr><tr><td>foo</td></tr><tr><td>foo</td></tr>
                            </table>
                        </article>
                    </section><section id="section-2">
                        <article>
                            <table>
                            	<tr><td>foo</td></tr><tr><td>foo</td></tr><tr><td>foo</td></tr>
                            	<tr><td>foo</td></tr><tr><td>foo</td></tr><tr><td>foo</td></tr>
                            	<tr><td>foo</td></tr><tr><td>foo</td></tr><tr><td>foo</td></tr>
                            </table>
                        </article>
                    </section>`;

	    $("#rightloader").before(data);
	    rightscene.update();
	    if (!$('#rightloader').is(':offscreen')) {
	    	setTimeout(function() {fetchInfo('right');}, 500);
	        console.log("asking right");
	    } else {
			rightfetching = false;
	    }  
	} else {
		if (leftsetup) {
	    	data = `<section id="section-3">
	                        <article>
	                            Three
	                        </article>
	                    </section><section id="section-4">
	                        <article>
	                            Four
	                        </article>
	                    </section>`;


		    $("#leftloader").after(data);
		    leftscene.update();
		    controller.scrollTo($('#leftloader').width()+10);
	    	leftfetching = false;
	    } else {
	    	console.log("done")
	    	leftsetup = true;
	    	leftfetching = false;
	    }
	}                
}

$('#dateicon').datepicker({
    startView: 1,
    minViewMode: 1,
    maxViewMode: 2
}).on('changeDate', function(ev){
    window.location.assign("/grid.html?bk={{the_band_key.urlsafe()}}&m="+(ev.date.getMonth()+1)+"&y="+(ev.date.getFullYear()))
});

// $('#grid_date').datepicker({
//                                 todayBtn: 'linked',
//                                 todayHighlight: true,
//                                 language: '{{ the_user.preferences.locale }}',
//                                 viewMode: 'months',
//                                 minViewMode: 'months'
//                             }).on('changeDate', function(ev){
//                                                                 window.location.assign("/grid.html?bk={{the_band_key.urlsafe()}}&m="+(ev.date.getMonth()+1)+"&y="+(ev.date.getFullYear()))
//                                                             });
// d=new Date({{the_year}},{{the_month-1}});
// $('#grid_date').datepicker('update', d);


$( document ).ready(function() {
    console.log( "ready!" );
    setUpLeft();
});


</script>
{% endblock localscripts %}
