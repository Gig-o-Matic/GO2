{% extends 'go2base.html' %}

{% block title %}{% trans %}Gig Edit{% endtrans %}{% endblock title %}

{% block headcontent %}
<link href="/timepicker/jquery.timepicker.css" rel="stylesheet" />
{% endblock headcontent %}

{% block content %}
    <div class="row">
        <div class="page-header col-md-8 col-md-offset-2">
        {% if newgig_is_active %}
            {% trans %}New Gig for {% endtrans %}{{ the_band.name }}
        {% else %}
            {% trans %}Gig Edit{% endtrans %}
        {% endif %}
        </div>
    </div>
    <form class="form" id="infoform" role="form" method="post" action="gig_edit.html">
        <input type="hidden" name="gig_band" value="{{the_band.key.urlsafe()}}">
        <div class="row">
            <div class="form-group col-md-8 col-md-offset-2">
                <label for="gigtitleinput" class="control-label">{% trans %}Gig Title{% endtrans %}</label>
                <input type="text" class="form-control" id="gigtitleinput" placeholder="({%trans%}required{%endtrans%})" value="{% if is_dupe %}{%trans%}Copy of{%endtrans%} {% endif %}{{gig.title}}" name="gig_title">
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4 col-md-offset-2">
                <label for="gigcontact" class="control-label">{% trans %}Contact{% endtrans %}</label>
                <select class="form-control" name="gig_contact" id="gig-contacts">
                </select>
            </div>
            <div class="form-group col-md-2 col-sm-4 col-xs-4">
                <label for="gigstatusinput" class="control-label">{% trans %}Status{% endtrans %}</label>
                    <select class="form-control" id="gigstatusinput" name="gig_status">
                        <option value="0"
                        {% if gig.status==0 %}selected{% endif %}
                        >{% trans %}Unconfirmed{% endtrans %}</option>
                        <option value="1"
                        {% if gig.status==1 %}selected{% endif %}
                        >{% trans %}Confirmed!{% endtrans %}</option>
                        <option value="2"
                        {% if gig.status==2 %}selected{% endif %}
                        >{% trans %}Cancelled!{% endtrans %}</option>
                    </select>
            </div>
            <div class="form-group col-md-2">
                <label class="checkbox">  
                    <input type="checkbox" id="gig_private" name="gig_private"
                    {% if gig.is_private %}
                    checked
                    {% endif %}
                    >{% trans %}Hide From Public Page{% endtrans %}  
                </label>  
            </div>
             
        </div>
        <div class="row">
            <div class="form-group col-md-2 col-md-offset-2 col-sm-4 col-xs-4">
                <label for="gigdateinput" class="control-label">{% trans %}Date{% endtrans %}</label>
                <input type="text" class="datepicker form-control" id="gigdateinput" name="gig_date" placeholder="({%trans%}required{%endtrans%})" 
                {% if gig != None %} value="{{ the_date_formatter(the_user, gig.date, 'datepicker')}}" {% endif %}
                name="gig_date">
            </div>
            <div class="form-group col-md-2 col-sm-4 col-xs-4">
                <label for="gigenddateinput" class="control-label">{% trans %}End Date{% endtrans %}</label>
                <input type="text" class="datepicker form-control" id="gigenddateinput" name="gig_enddate" placeholder="({% trans %}if multi-day{% endtrans %})" 
                {% if gig != None  and gig.enddate != None %} value="{{ the_date_formatter(the_user, gig.enddate, 'datepicker')}}" {% endif %}
                name="gig_enddate">
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-2 col-md-offset-2 col-sm-4 col-xs-4">
                <label for="gigcallinput" class="control-label">{% trans %}Call Time{% endtrans %}</label>
                <input type="text" class="form-control" id="gigcallinput" placeholder="4:20" value="{{gig.calltime}}" name="gig_call">
            </div>
            <div class="form-group col-md-2 col-sm-4 col-xs-4">
                <label for="gigsetinput" class="control-label">{% trans %}Set Time{% endtrans %}</label>
                <input type="text" class="form-control" id="gigsetinput" placeholder="" value="{{gig.settime}}" name="gig_set">
            </div>
            <div class="form-group col-md-2 col-sm-4 col-xs-4">
                <label for="gigendinput" class="control-label">{% trans %}End Time{% endtrans %}</label>
                <input type="text" class="form-control" id="gigendinput" placeholder="" value="{{gig.endtime}}" name="gig_end">
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-offset-2 col-md-4 col-sm-4 col-xs-4">
                <label for="gigaddressinput" class="control-label">{% trans %}Address{% endtrans %}</label>
                <input type="text" class="form-control" id="gigaddressinput" placeholder="{% trans %}location_placeholder{% endtrans %}" value="{{gig.address}}" name="gig_address">
            </div>
            <div class="form-group col-md-2 col-sm-4 col-xs-4">
                <label for="gigdressinput" class="control-label">{% trans %}What To Wear{% endtrans %}</label>
                <input type="text" class="form-control" id="gigdressinput" placeholder="{% trans %}Pants Optional{% endtrans %}" value="{{gig.dress}}" name="gig_dress">
            </div>
            <div class="form-group col-md-2 col-sm-4 col-xs-4">
                <label for="gigpaidinput" class="control-label">{% trans %}Pay Deal{% endtrans %}</label>
                <input type="text" class="form-control" id="gigpaidinput" placeholder="{% trans %}As If{% endtrans %}" value="{{gig.paid}}" name="gig_paid">
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-offset-2 col-md-4 col-sm-4 col-xs-4">
                <label for="gigleaderinput" class="control-label">{% trans %}Leader{% endtrans %}</label>
                <input type="text" class="form-control" id="gigleaderinput" placeholder="{% trans %}leader_placeholder{% endtrans %}" value="{{gig.leader}}" name="gig_leader">
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-8 col-md-offset-2">
                <label for="gigdetailsinput" class="control-label">{% trans %}More Details{% endtrans %}</label>
                <textarea class="form-control" rows="10" id="gigdetailsinput" placeholder="{% trans %}who? what? where? when? why?{% endtrans %}" name="gig_details">{{gig.details}}</textarea>
            </div>
        </div>            
        <div class="row">
            <div class="form-group col-md-8 col-md-offset-2">
                <label for="gigsetlistinput" class="control-label">{% trans %}Setlist{% endtrans %}</label>
                <textarea class="form-control" rows="10" id="gigsetlistinput" placeholder="{% trans %}setlist here{% endtrans %}" name="gig_setlist">{{gig.setlist}}</textarea>
            </div>
        </div>
        
        {% if newgig_is_active %}
            <div class="row">
                <div class="form-group col-md-8 col-md-offset-2">
                    <label class="checkbox">  
                        <input type="checkbox" id="newgig_notifymembers" name="gig_notifymembers" checked
                        >{% trans %}Email members about this new gig{% endtrans %}  
                    </label>  
                </div>
            </div>
        {% endif %}
        
        <div class="row">
            <div class="form-group col-md-4 col-md-offset-2 col-sm-6 col-sm-offset-0 col-xs-6 col-xs-offset-0">
                {% if gig!=None and not is_dupe%}
                    <a data-toggle="modal" href="#deleteModal" class="btn btn-default">{% trans %}Delete{% endtrans %}</a>
                    <a data-toggle="modal" href="#archiveModal" class="btn btn-default">{% trans %}Archive{% endtrans %}</a>
                {% endif %}   
            </div>
            <div class="form-group col-md-4 text-right">                
                    {% if gig==None %}
                        <a class="btn btn-default" href="/">{% trans %}Cancel{% endtrans %}</a>
                    {% else %}
                        <a class="btn btn-default" href="gig_info.html?gk={{ gig.key.urlsafe() }}">{% trans %}Cancel{% endtrans %}</a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">{% trans %}Save{% endtrans %}</button>
            </div>
        </div>
        {% if gig==None or is_dupe %}
            <input type="hidden" name="gk" value="0">
        {% else %}
            <input type="hidden" name="gk" value="{{gig.key.urlsafe()}}">
        {% endif %}
    </form>
{% endblock content %}        

{% block modal %}
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">{% trans %}Confirm Delete{% endtrans %}</h4>
                </div>
                <div class="modal-body">
                    {% trans %}Do you really want to delete this gig?{% endtrans %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Don't Delete{% endtrans %}</button>
                    {% if gig %}
                        <a class="btn btn-primary" id="opener" href="gig_delete?&gk={{ gig.key.urlsafe() }}">{% trans %}Delete{% endtrans %}</a>
                    {% endif %}
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" id="archiveModal" tabindex="-1" role="dialog" aria-labelledby="archiveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">{% trans %}Confirm archive{% endtrans %}</h4>
                </div>
                <div class="modal-body">
                    {% trans %}Do you really want to archive this gig?{% endtrans %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Don't Archive{% endtrans %}</button>
                    {% if gig %}
                        <a class="btn btn-primary" id="opener" href="gig_archive?&gk={{ gig.key.urlsafe() }}">{% trans %}Archive{% endtrans %}</a>
                    {% endif %}
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock modal %}
{% block localscripts %}
<script src="/datepicker/js/bootstrap-datepicker.js"></script>
<script src="/datepicker/js/locales/bootstrap-datepicker.{{ the_user.preferences.locale }}.js"></script>
<script src="/js/jquery.validate.js"></script>
<script src="/timepicker/jquery.timepicker.min.js"></script>
{% if the_user.preferences.locale == 'en' %}
<script src='/js/moment.min.js'></script>
{% else %}
<script src='/js/moment-with-langs.min.js'></script>
{% endif %}
<script>
$(document).ready(function () {
    $('#gigdateinput').datepicker({
                language: '{{ the_user.preferences.locale }}'
            });
    $('#gigdateinput')
      .on('changeDate', function(ev){
        $('#gigdateinput').datepicker('hide')
      });
      
    $('#gigenddateinput').datepicker({
                language: '{{ the_user.preferences.locale }}'
            });
    $('#gigenddateinput')
      .on('changeDate', function(ev){
        $('#gigenddateinput').datepicker('hide')
      });


    $.validator.addMethod(
        "gigoDate",
        function(value, element) {
            if (value=="") {
                return true;
            } else {
                // put your own logic here, this is just a (crappy) example
                return value.match(/^\d\d?\/\d\d?\/\d\d\d\d$/);
            }
        },
        "{% trans %}Please enter a date in the format mm/dd/yyyy.{% endtrans %}"
    );
      
    $("#infoform").validate({
        rules: {
            gig_title: {
                required: true
            },
            gig_date: {
                required: true,
                gigoDate: true,
                inFuture: true
            },
            gig_enddate: {
                gigoDate: true,
                greaterThan: "#gigdateinput"
            }
        },
        messages: {
            gig_title: {
                required: "{% trans %}This field is required!{% endtrans %}"                
            },            
            gig_date: {
                required: "{% trans %}This field is required!{% endtrans %}"                
            },            
            gig_enddate: {
                required: "{% trans %}This field is required!{% endtrans %}"                
            }            
        }
    });

    $('#gigcallinput').timepicker({'timeFormat':'{% trans %}time_format{% endtrans %}'});
    $('#gigsetinput').timepicker({'timeFormat':'{% trans %}time_format{% endtrans %}'});
    $('#gigendinput').timepicker({'timeFormat':'{% trans %}time_format{% endtrans %}'});
      
    updateContactList('{{the_band.key.urlsafe()}}');
});

jQuery.validator.addMethod("greaterThan", 
function(value, element, params) {

    if (value=="") {
        return true;
    }

    {% if the_user.preferences.locale != 'en' %} 
        moment.lang('{{the_user.preferences.locale}}');
    {% endif %}
    d1 = moment(value,moment.langData('{{ the_user.preferences.locale }}').longDateFormat("L"));
    d2 = moment($(params).val(),moment.langData('{{ the_user.preferences.locale }}').longDateFormat("L"));

    return d1 > d2;
},'{% trans %}Must be later than start date!{% endtrans %}');

jQuery.validator.addMethod("inFuture", 
function(value, element, params) {
    today = moment();
    today.hour(0);
    today.minute(0);
    today.second(0);
    today.millisecond(0);
    {% if the_user.preferences.locale != 'en' %} 
        moment.lang('{{the_user.preferences.locale}}');
    {% endif %}
    d1 = moment(value,moment.langData('{{ the_user.preferences.locale }}').longDateFormat("L"));
    return d1 >= today;
},'{% trans %}Must be in the future!{% endtrans %}');

function updateContactList(bk) {
    $.post("/band_get_member_list",
                {
                    bk: bk
                },
                function(responseTxt,statusTxt,xhr){
                    if(statusTxt=="success")
                        obj = JSON && JSON.parse(responseTxt) || $.parseJSON(responseTxt);
                        inner=""
                        {% if gig.contact==None %}
                            inner = inner+"<option value=''>??</option>"
                        {% endif %}
                        for(i=0; i<obj.length; i++) {
                            inner=inner+"<option value='"+obj[i][1]+"'"
                            {% if newgig_is_active %}
                                if (obj[i][1] == '{{the_user.key.urlsafe()}}') {
                                    inner=inner+" SELECTED"
                                }
                            {% elif gig.contact %}
                                if (obj[i][1] == '{{gig.contact.urlsafe()}}') {
                                    inner=inner+" SELECTED"
                                }
                            {% endif %}
                            inner=inner+">"+obj[i][0]+"</option>"
                        }
                        $('#gig-contacts').html(inner);
                    if(statusTxt=="error")
                      alert("{% trans %}Error{% endtrans %}: "+xhr.status+": "+xhr.statusText);
                });
}

function handleBandChange(sel) {
    var bk=sel.value;
    updateContactList(bk);
};

</script>
{% endblock localscripts %}

